<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SharkTube – Collapsible Flyout Portal</title>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <style>
    :root{--w:960px;--menu-width:300px;--flyout-width:350px;--color-accent:#BEA876;--color-primary-bg:#283891;--color-bg-dark:#0b0d10;--color-text-white:#fff;--color-dark-hover:#3a4a9f}
    body{margin:0;min-height:100vh;background:var(--color-bg-dark);color:var(--color-text-white);font-family:system-ui,sans-serif;display:flex;justify-content:center;align-items:flex-start;padding:20px}
    .container{display:flex;width:calc(var(--w) + var(--menu-width) + var(--flyout-width) + 60px);max-width:100%;gap:20px;position:relative}
    .content-area{flex-grow:1}
    #sidebar{width:var(--menu-width);background:var(--color-primary-bg);border-radius:12px;padding:15px;box-shadow:0 4px 12px rgba(0,0,0,.3);max-height:calc(100vh - 40px);overflow-y:auto;position:relative;z-index:10}
    #sidebarHeader{display:flex;justify-content:flex-end;align-items:center;margin-bottom:10px}
    #refreshBtn{background:var(--color-dark-hover);color:var(--color-text-white);border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:1em;line-height:1;transition:background-color .2s}
    #refreshBtn:hover{background:var(--color-accent);color:var(--color-primary-bg)}
    #loadingMessage{padding:10px;font-size:.9em}
    .teacher-list,.category-list{list-style:none;padding:0;margin:0}
    .teacher-header{font-weight:700;font-size:1.1em;color:var(--color-accent);padding:10px 5px;margin-top:10px;cursor:pointer;user-select:none;display:flex;justify-content:space-between;border-bottom:2px solid var(--color-dark-hover)}
    .teacher-header::after{content:'+';font-size:1.1em;transition:transform .3s}
    .teacher-header.open::after{content:'-'}
    .collapsible-header{padding:8px 5px;margin-bottom:5px;color:var(--color-text-white);font-size:1em;cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--color-dark-hover);transition:background-color .2s;padding-left:25px}
    .collapsible-header:hover{background-color:var(--color-dark-hover)}
    .collapsible-header.active{background-color:var(--color-accent);color:var(--color-primary-bg)}
    .collapsible-content{max-height:0;overflow:hidden;transition:max-height .25s ease}
    #videoFlyout{position:absolute;top:0;left:calc(var(--menu-width) + 20px);width:var(--flyout-width);background:var(--color-primary-bg);border-radius:12px;padding:15px;box-shadow:8px 8px 20px rgba(0,0,0,.5);max-height:calc(100vh - 40px);overflow-y:auto;display:none;z-index:20;opacity:0;transform:translateX(20px);transition:opacity .2s ease,transform .2s ease}
    #videoFlyout.show{opacity:1;transform:translateX(0)}
    #flyoutHeader{font-size:1.15em;font-weight:700;color:var(--color-accent);margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid var(--color-dark-hover);display:flex;justify-content:space-between;align-items:center}
    #closeFlyoutBtn{background:none;border:none;color:var(--color-accent);font-size:1.5em;cursor:pointer;padding:0 5px;line-height:1;transition:color .2s}
    #closeFlyoutBtn:hover{color:var(--color-text-white)}
    .video-list{list-style:none;padding:0;margin:0}
    .video-list li{padding:8px 10px;cursor:pointer;border-left:3px solid transparent;transition:background-color .2s,border-left-color .2s;font-size:.95em;line-height:1.3;color:var(--color-text-white)}
    .video-list li.selected{border-left-color:var(--color-accent);font-weight:700}
    .video-list li:hover{background-color:var(--color-dark-hover)}
    .wrap{position:relative;width:100%;max-width:var(--w);aspect-ratio:16/9;background:#000;border-radius:12px 12px 0 0;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.4)}
    #player{width:100%;height:100%;pointer-events:none}
    .controls{width:100%;max-width:var(--w);background:var(--color-primary-bg);padding:10px 15px;display:flex;align-items:center;gap:15px;box-shadow:0 8px 24px rgba(0,0,0,.4);border-radius:0 0 12px 12px;font-size:.9em}
    #fullscreenBtn{background-color:var(--color-accent);color:var(--color-primary-bg);padding:5px 10px;border-radius:6px;font-weight:700;font-size:.9em;letter-spacing:.05em;text-transform:uppercase;transition:opacity .2s;flex-shrink:0;margin-left:auto}
    #fullscreenBtn:hover{opacity:.9}
    .btn{background:none;border:none;color:#fff;cursor:pointer;font-size:20px}
    #seekRange{flex-grow:1}
    input[type=range]{-webkit-appearance:none;appearance:none;height:5px;background:#555;cursor:pointer;border-radius:5px}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:15px;height:15px;border-radius:50%;background:var(--color-accent);cursor:pointer}
    .finished{position:absolute;inset:0;display:grid;place-items:center;background:var(--color-bg-dark);text-align:center;padding:2rem}
    .content-area:fullscreen{position:fixed;top:0;left:0;width:100vw;height:100vh;margin:0;padding:0;z-index:21;background-color:var(--color-bg-dark);display:flex;flex-direction:column;justify-content:center;align-items:center}
    .content-area:fullscreen .wrap{width:100%;max-width:100%;flex-grow:1;max-height:calc(100vh - 60px);aspect-ratio:16/9;object-fit:contain;margin:auto;border-radius:0;box-shadow:none}
    .content-area:fullscreen .controls{flex-shrink:0;border-radius:0;width:100%}
    .content-area:fullscreen .finished{width:100%;height:100%;padding-top:50px}
    /* tiny banner if YT API blocked */
    #ytNotice{display:none;margin:8px 0 0 0;font-size:.85em;color:#ffd5d5}
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT: Sidebar -->
    <div id="sidebar">
      <div id="sidebarHeader">
        <button id="refreshBtn" title="Refresh Video List">↻</button>
      </div>
      <p id="loadingMessage">Loading videos...</p>
      <ul class="teacher-list" id="menuList" style="display:none"></ul>
      <p id="ytNotice">YouTube player blocked by network filter — browsing list still works.</p>
    </div>

    <!-- MIDDLE: Flyout -->
    <div id="videoFlyout" style="display:none;">
      <div id="flyoutHeader">
        <span id="flyoutHeaderText">Videos in Category</span>
        <button id="closeFlyoutBtn" title="Close Video List">←</button>
      </div>
      <ul class="video-list" id="flyoutList"></ul>
    </div>

    <!-- RIGHT: Player & Controls -->
    <div class="content-area">
      <div class="wrap">
        <div id="player" referrerpolicy="strict-origin-when-cross-origin"></div>
        <div class="finished" id="finished" style="display:none">
          <div>
            <h2>All done.</h2>
            <p>This video has ended. Click a title on the left to watch another.</p>
          </div>
        </div>
      </div>
      <div class="controls" id="controls" style="display:none;">
        <button class="btn" id="playPauseBtn">▶</button>
        <span id="currentTimeSpan">0:00</span>
        <input type="range" id="seekRange" min="0" max="100" value="0">
        <span id="durationSpan">0:00</span>
        <input type="range" id="volumeRange" min="0" max="100" value="100" style="width:80px;">
        <button class="btn" id="fullscreenBtn" title="Toggle Fullscreen">FULLSCREEN</button>
      </div>
    </div>
  </div>

  <!-- YouTube API (menu works even if this is blocked) -->
  <script src="https://www.youtube.com/iframe_api" referrerpolicy="strict-origin-when-cross-origin"></script>
  <script>
    // -------------------- Config --------------------
    const JSON_URL = './videos.json'; // local-only source of truth

    // -------------------- State ---------------------
    let VIDEO_DATA = [];
    let player, updateTimer, isPlayerReady = false;
    let activeCategoryHeader = null;
    let pendingVideoId = null;

    // -------------------- DOM -----------------------
    const finishedEl = document.getElementById('finished');
    const controlsEl = document.getElementById('controls');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const seekRange = document.getElementById('seekRange');
    const volumeRange = document.getElementById('volumeRange');
    const menuListEl = document.getElementById('menuList');
    const loadingMessageEl = document.getElementById('loadingMessage');
    const flyoutEl = document.getElementById('videoFlyout');
    const flyoutHeaderTextEl = document.getElementById('flyoutHeaderText');
    const flyoutListEl = document.getElementById('flyoutList');
    const closeFlyoutBtn = document.getElementById('closeFlyoutBtn');
    const currentTimeSpan = document.getElementById('currentTimeSpan');
    const durationSpan = document.getElementById('durationSpan');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const contentAreaEl = document.querySelector('.content-area');
    const refreshBtn = document.getElementById('refreshBtn');
    const ytNotice = document.getElementById('ytNotice');

    // -------------------- Utils ---------------------
    function formatTime(s){ if(isNaN(s)||s<0) return '0:00'; const m=Math.floor(s/60); const ss=String(Math.floor(s%60)).padStart(2,'0'); return `${m}:${ss}`; }

    // -------------------- YouTube -------------------
    window.onYouTubeIframeAPIReady = function () {
      isPlayerReady = true;
      const first = pendingVideoId || VIDEO_DATA[0]?.categories?.[0]?.videos?.[0]?.id;
      if (first) initializePlayer(first);
    };

    function initializePlayer(initialVideoId) {
      if (player) { try { player.destroy(); } catch {} if (updateTimer) clearInterval(updateTimer); }
      player = new YT.Player('player', {
        videoId: initialVideoId,
        host: 'https://www.youtube-nocookie.com',
        playerVars: { controls:0, disablekb:1, rel:0, fs:0, iv_load_policy:3, modestbranding:1, playsinline:1, enablejsapi:1, origin: location.origin },
        events: { onReady, onStateChange, onError: e => console.error('YouTube Player Error:', e.data) }
      });
    }

    function onReady(){
      controlsEl.style.display='flex';
      player.setVolume(100);
      durationSpan.textContent = formatTime(player.getDuration());
      playPauseBtn.addEventListener('click', togglePlayPause);
      volumeRange.addEventListener('input', () => player.setVolume(parseInt(volumeRange.value,10)));
      seekRange.addEventListener('change', () => {
        const d = player.getDuration(); player.seekTo((seekRange.value/100)*d,true);
        if (player.getPlayerState() !== YT.PlayerState.PLAYING){ player.playVideo(); playPauseBtn.textContent='⏸'; }
      });
      fullscreenBtn.addEventListener('click', toggleFullscreen);
      document.addEventListener('fullscreenchange', handleFullscreenChange);
      if (updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(updatePlayerState, 1000);
      if (pendingVideoId) { player.cueVideoById(pendingVideoId); pendingVideoId=null; }
    }

    function onStateChange(e){
      if (e.data === YT.PlayerState.ENDED){
        if (updateTimer) clearInterval(updateTimer);
        try { player.cueVideoById(player.getVideoData().video_id); } catch {}
        controlsEl.style.display='none'; finishedEl.style.display='grid';
      }
    }
    function updatePlayerState(){
      if (!(player && player.getPlayerState)) return;
      const state = player.getPlayerState(), t = player.getCurrentTime(), d = player.getDuration();
      currentTimeSpan.textContent = formatTime(t);
      if (d > 0 && durationSpan.textContent === '0:00') durationSpan.textContent = formatTime(d);
      if (state === YT.PlayerState.PLAYING){ seekRange.value = (t/d)*100; playPauseBtn.textContent='⏸'; }
      else if (state === YT.PlayerState.PAUSED){ playPauseBtn.textContent='▶'; }
    }
    function togglePlayPause(){ const s = player.getPlayerState(); if (s===YT.PlayerState.PLAYING){ player.pauseVideo(); playPauseBtn.textContent='▶'; } else { player.playVideo(); playPauseBtn.textContent='⏸'; } }
    function toggleFullscreen(){ if (!document.fullscreenElement){ contentAreaEl.requestFullscreen?.().catch(err=>console.error('Fullscreen error:',err)); } else { document.exitFullscreen?.(); } }
    function handleFullscreenChange(){ fullscreenBtn.textContent = document.fullscreenElement ? 'EXIT FULLSCREEN' : 'FULLSCREEN'; }

    // -------------------- Data (local only) --------
    async function loadLocalData(){
      menuListEl.style.display='none';
      flyoutEl.style.display='none';
      loadingMessageEl.style.display='block';
      loadingMessageEl.textContent='Loading videos...';

      try{
        const url = `${JSON_URL}?t=${Date.now()}`; // cache-buster
        console.log('[LOAD] fetching', url);
        const res = await fetch(url, { cache:'no-store' });
        if (!res.ok) throw new Error(`videos.json HTTP ${res.status}`);
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) throw new Error('videos.json empty or wrong shape');

        const firstId = data?.[0]?.categories?.[0]?.videos?.[0]?.id;
        if (!firstId) throw new Error('videos.json missing first video at [0].categories[0].videos[0].id');

        VIDEO_DATA = data;
        console.log('[LOAD] videos.json ok:', VIDEO_DATA.length, 'teachers');
        renderMenu();

        loadingMessageEl.style.display='none';
        menuListEl.style.display='block';

        // open first section and prep player
        pendingVideoId = firstId;
        const firstTeacherHeader = menuListEl.querySelector('.teacher-header');
        if (firstTeacherHeader){
          const firstTeacherContent = firstTeacherHeader.nextElementSibling;
          toggleCollapse(firstTeacherHeader, firstTeacherContent);
          const firstCategoryHeader = firstTeacherContent?.querySelector('.collapsible-header');
          if (firstCategoryHeader) handleCategoryClick({ currentTarget:firstCategoryHeader, stopPropagation(){ } });
        }
        if (isPlayerReady && firstId) initializePlayer(firstId);

        setTimeout(()=>{ if (!isPlayerReady) ytNotice.style.display='block'; }, 2500);
      }catch(err){
        console.error('[LOAD] FATAL:', err);
        loadingMessageEl.innerHTML = `<b style="color:#ff6b6b">Could not load videos.json</b><br>${String(err.message || err)}`;
      }
    }

    // -------------------- Menu ---------------------
    function renderMenu(){
      menuListEl.innerHTML='';
      VIDEO_DATA.forEach(teacherItem=>{
        const teacherHeader = document.createElement('div');
        teacherHeader.className='teacher-header';
        teacherHeader.textContent = teacherItem.teacher;

        const teacherContent = document.createElement('div');
        teacherContent.className='collapsible-content teacher-content';

        const categoryUl = document.createElement('ul');
        categoryUl.classList.add('category-list');

        teacherItem.categories.forEach(categoryItem=>{
          const categoryHeader = document.createElement('div');
          categoryHeader.className='collapsible-header';
          categoryHeader.textContent = categoryItem.name;
          categoryHeader.dataset.videos = JSON.stringify(categoryItem.videos);
          categoryHeader.addEventListener('click', handleCategoryClick);

          const li = document.createElement('li');
          li.appendChild(categoryHeader);
          categoryUl.appendChild(li);
        });

        teacherContent.appendChild(categoryUl);
        teacherHeader.addEventListener('click', (e)=>{ toggleCollapse(teacherHeader, teacherContent); e.stopPropagation(); });

        const teacherLi = document.createElement('li');
        teacherLi.appendChild(teacherHeader);
        teacherLi.appendChild(teacherContent);
        menuListEl.appendChild(teacherLi);
      });
    }

    function toggleCollapse(headerEl, contentEl){
      if (!contentEl) return;
      if (headerEl.classList.contains('open')){ contentEl.style.maxHeight=0; headerEl.classList.remove('open'); }
      else { contentEl.style.maxHeight = contentEl.scrollHeight + 'px'; headerEl.classList.add('open'); updateParentMaxHeight(headerEl); }
    }
    function updateParentMaxHeight(el){
      let cur = el.parentElement;
      while (cur && cur.classList.contains('collapsible-content')){
        if (cur.previousElementSibling?.classList.contains('teacher-header')) cur.style.maxHeight = cur.scrollHeight + 'px';
        cur = cur.parentElement;
      }
    }

    function closeFlyout(){
      flyoutEl.classList.remove('show');
      setTimeout(()=>{ flyoutEl.style.display='none'; }, 180);
      if (activeCategoryHeader){ activeCategoryHeader.classList.remove('active'); activeCategoryHeader=null; }
    }

    function handleCategoryClick(e){
      e.stopPropagation();
      const headerEl = e.currentTarget;
      const videos = JSON.parse(headerEl.dataset.videos);
      const categoryName = headerEl.textContent.trim();

      flyoutHeaderTextEl.textContent = categoryName;
      flyoutListEl.innerHTML = '';

      videos.forEach(v=>{
        const li = document.createElement('li');
        li.textContent = v.title;
        li.dataset.videoId = v.id;
        li.addEventListener('click', handleVideoClick);
        flyoutListEl.appendChild(li);
      });

      document.querySelectorAll('.collapsible-header').forEach(h=>h.classList.remove('active'));
      headerEl.classList.add('active');
      activeCategoryHeader = headerEl;
      
      // Position flyout adjacent to clicked category
      const sidebarRect = document.getElementById('sidebar').getBoundingClientRect();
      const headerRect = headerEl.getBoundingClientRect();
      flyoutEl.style.left = `${sidebarRect.width + 20}px`;
      flyoutEl.style.top = `${headerRect.top - sidebarRect.top}px`;
      
      flyoutEl.style.display='block';
      requestAnimationFrame(()=>flyoutEl.classList.add('show'));
    }

    function handleVideoClick(e){
      const newId = e.currentTarget.dataset.videoId;
      pendingVideoId = newId;
      if (!isPlayerReady){
        document.querySelectorAll('#flyoutList li').forEach(li=>li.classList.remove('selected'));
        e.currentTarget.classList.add('selected');
        return;
      }
      player.cueVideoById(newId);
      finishedEl.style.display='none';
      controlsEl.style.display='flex';
      playPauseBtn.textContent='▶';
      seekRange.value=0;
      document.querySelectorAll('#flyoutList li').forEach(li=>li.classList.remove('selected'));
      e.currentTarget.classList.add('selected');
      closeFlyout();
    }

    document.addEventListener('click', (e)=>{
      const inFlyout = flyoutEl.contains(e.target);
      const inSidebar = document.getElementById('sidebar').contains(e.target);
      if (flyoutEl.style.display !== 'none' && !inFlyout && !inSidebar) closeFlyout();
    });

    refreshBtn?.addEventListener('click', loadLocalData);
    closeFlyoutBtn?.addEventListener('click', closeFlyout);

    // Boot
    addEventListener('contextmenu', e=>e.preventDefault());
    addEventListener('keydown', e=>{ const blocked=['ArrowLeft','ArrowRight','c','m']; if (blocked.includes(e.key.toLowerCase())){ e.preventDefault(); e.stopPropagation(); } }, {passive:false});
    loadLocalData();
  </script>
</body>
</html>
